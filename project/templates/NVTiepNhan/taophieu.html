{% extends 'layout/base.html' %}

{% block content %}
<section class="container">
    <h1 class="text-center text-primary">
        {{ 'Cập nhật Phiếu Tiếp Nhận' if ptn else 'Lập Phiếu Tiếp Nhận Mới' }}
    </h1>
{% include 'layout/flash_messages.html' %}
    <form id="phieuForm" method="POST" action="{{ url_for('tiepnhan_edit', id=ptn.id) if ptn else url_for('tiepnhan_taophieu') }}">

        <fieldset class="border p-3 mb-3">
            <legend class="w-auto px-2">1. Thông tin khách hàng</legend>
            <div class="mb-3">
                <label for="customer_name" class="form-label">Họ tên khách hàng</label>
                <input type="text" class="form-control" id="customer_name" name="customer_name"
                       value="{{ ptn.xe.khachhang.name if ptn else '' }}"
                       {{ 'disabled' if ptn else 'required' }}>
            </div>
            <div class="mb-3">
                <label for="customer_sdt" class="form-label">Số điện thoại</label>
                <input type="tel" class="form-control" id="customer_sdt" name="customer_sdt"
                       pattern="[0-9]{1,10}" inputmode="numeric"
                       maxlength="10"
                       value="{{ ptn.xe.khachhang.sdt if ptn else '' }}"
                       {{ 'disabled' if ptn else 'required' }}>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-3">
            <legend class="w-auto px-2">2. Thông tin xe</legend>
            <div class="mb-3">
                <label for="xe_bien_so" class="form-label">Biển số xe</label>
                <input type="text" class="form-control" id="xe_bien_so" name="xe_bien_so"
                       value="{{ ptn.xe.bien_so if ptn else '' }}"
                       {{ 'disabled' if ptn else 'required' }}>
            </div>
            <div class="mb-3">
                <label for="xe_loai_xe" class="form-label">Loại xe</label>
                <select class="form-select" id="xe_loai_xe" name="xe_loai_xe"
                        {{ 'disabled' if ptn else 'required' }}>
                <option value="" disabled selected>-- Chọn loại xe --</option>
                {% for lx in loai_xes %}
                <option value="{{ lx.name }}"
                        {{ 'selected' if ptn and ptn.xe.loai_xe.name == lx.name else '' }}>
                {{ lx.value }}
                </option>
                {% endfor %}
                </select>
            </div>
        </fieldset>

        <fieldset class="border p-3 mb-3">
            <legend class="w-auto px-2">3. Thông tin lỗi (Được phép sửa)</legend>
            <div class="mb-3" id="loiGroup">
                <label class="form-label">Các lỗi ghi nhận:</label>
                {% for loi in lois %}
                <div class="form-check">
                    <input class="form-check-input loi-checkbox" type="checkbox" name="loi_ids" value="{{ loi.id }}"
                           id="loi-{{ loi.id }}"
                           {% if ptn and loi in ptn.lois %}checked{% endif %}>
                    <label class="form-check-label" for="loi-{{ loi.id }}">
                        {{ loi.ten_loi }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </fieldset>

        <div class="text-center">
            <button type="submit" class="btn btn-success btn-lg">
                {{ 'Cập nhật Phiếu' if ptn else 'Lưu Phiếu' }}
            </button>
            <a href="{{ url_for('tiepnhan_dashboard') }}" class="btn btn-secondary btn-lg">Hủy</a>
        </div>
    </form>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sdtInput = document.getElementById('customer_sdt');
    const form = document.getElementById('phieuForm');

    // Chặn nhập ký tự không phải số và tối đa 10 ký tự
    sdtInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '');
        if (this.value.length > 10) this.value = this.value.slice(0, 10);
    });
    // Validate checkbox lỗi trước khi submit
    form.addEventListener('submit', function(e) {
        const checkboxes = document.querySelectorAll('.loi-checkbox');
        const checked = Array.from(checkboxes).some(cb => cb.checked);

        if (!checked) {
            e.preventDefault(); // chặn submit
            alert("Bạn phải chọn ít nhất 1 lỗi!");
            // Form giữ nguyên dữ liệu người dùng đã nhập
        }
    });
});
</script>
{% endblock %}
