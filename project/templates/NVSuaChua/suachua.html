{% extends 'layout/base.html' %}

{% block content %}
<section class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="text-primary">Trang Sửa Chữa (Xin chào, {{ current_user.name }})</h1>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
    </div>
    {% include 'layout/flash_messages.html' %}
    <hr>

    <h2 class="mb-3">Danh sách phiếu chờ sửa</h2>

    <!--    {% with messages = get_flashed_messages(with_categories=true) %}-->
    <!--    {% if messages %}-->
    <!--    {% for category, message in messages %}-->
    <!--    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">-->
    <!--        {{ message }}-->
    <!--        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>-->
    <!--    </div>-->
    <!--    {% endfor %}-->
    <!--    {% endif %}-->
    <!--    {% endwith %}-->

    <table class="table table-hover border">
        <thead class="table-light">
        <tr>
            <th>Phiếu TN #</th>
            <th>Ngày nhận</th>
            <th>Biển số xe</th>
            <th>Khách hàng</th>
            <th>Lỗi đã báo</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody>
        {% for ptn in phieu_cho_sua %}
        <tr>
            <td>{{ ptn.id }}</td>
            <td>{{ ptn.ngay_tiep_nhan.strftime('%d-%m-%Y') }}</td>
            <td>{{ ptn.xe.bien_so }}</td>
            <td>{{ ptn.xe.khachhang.name }}</td>
            <td>
                <ul>
                    {% for loi in ptn.lois %}
                    <li>{{ loi.ten_loi }}</li>
                    {% endfor %}
                </ul>
            </td>
            <td>
                <form action="{{ url_for('suachua_nhan_phieu', ptn_id=ptn.id) }}" method="POST">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Nhận sửa
                    </button>
                </form>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="6" class="text-center text-muted">Không có phiếu nào đang chờ sửa.</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="mt-5">
        <h2 class="mb-3 text-secondary border-top pt-3">Danh sách phiếu đang sửa / đã sửa</h2>

        <table class="table table-striped border">
            <thead class="table-light">
            <tr>
                <th>PSC ID</th>
                <th>Ngày sửa</th>
                <th>Biển số</th>
                <th>Nhân viên sửa</th>
                <th>Tổng tiền (Tạm tính)</th>
                <th>Chi tiết</th>
                <th>Delete</th>
            </tr>
            </thead>
            <tbody>
            {% for psc in pscs.items %}
            <tr>
                <td>#{{ psc.id }}</td>
                <td>{{ psc.ngay_sua_chua }}</td>
                <td>{{ psc.phieu_tiep_nhan.xe.bien_so }}</td>
                <td>{{ psc.nhan_vien_sua_chua.name }}</td>
                <td>{{ "{:,.0f}".format(psc.tong_tien) }} VNĐ</td>
                <td>
                    <a href="{{ url_for('suachua_chi_tiet', psc_id=psc.id) }}" class="btn btn-sm btn-primary">
                        Xem / Sửa
                    </a>
                </td>
                <td>
                    <form action="{{ url_for('suachua_delete', psc_id=psc.id) }}" method="POST"
                          onsubmit="return confirm('Bạn chắc chắn muốn xóa phiếu này? Phiếu tiếp nhận sẽ quay lại danh sách chờ.');">
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="bi bi-x-circle"></i> Hủy phiếu
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center">Chưa có phiếu sửa chữa nào trong hệ thống.</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not pscs.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('suachua_dashboard', page=pscs.prev_num) }}">
                        &laquo; Trước
                    </a>
                </li>

                {% for page_num in pscs.iter_pages() %}
                {% if page_num %}
                <li class="page-item {% if page_num == pscs.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('suachua_dashboard', page=page_num) }}">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
                {% endif %}
                {% endfor %}

                <li class="page-item {% if not pscs.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('suachua_dashboard', page=pscs.next_num) }}">
                        Tiếp &raquo;
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</section>
{% endblock %}