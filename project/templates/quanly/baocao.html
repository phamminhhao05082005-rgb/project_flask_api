{% extends 'quanly/base_quanly.html' %}

{% block quanly_content %}
<section class="container mt-4">
    <h2 class="mb-4">Báo cáo thống kê</h2>

    {% include 'layout/flash_messages.html' %}

    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Chọn loại thống kê</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Loại thống kê</label>
                    <select name="loai_thong_ke" class="form-select" onchange="this.form.submit()">
                        <option value="doanh_thu" {% if loai_thong_ke=='doanh_thu' %}selected{% endif %}>Doanh thu
                        </option>
                        <option value="loai_xe" {% if loai_thong_ke=='loai_xe' %}selected{% endif %}>Tỷ lệ loại xe
                        </option>
                        <option value="loi_thuong_gap" {% if loai_thong_ke=='loi_thuong_gap' %}selected{% endif %}>Lỗi
                            thường gặp
                        </option>
                    </select>
                </div>

                {% if loai_thong_ke == 'doanh_thu' %}
                <div class="col-md-4">
                    <label class="form-label fw-bold">Kiểu thống kê</label>
                    <select name="kieu_thong_ke" class="form-select" onchange="this.form.submit()">
                        <option value="ngay" {% if kieu_thong_ke=='ngay' %}selected{% endif %}>Theo ngày</option>
                        <option value="thang" {% if kieu_thong_ke=='thang' %}selected{% endif %}>Theo tháng</option>
                        <option value="quy" {% if kieu_thong_ke=='quy' %}selected{% endif %}>Theo quý</option>
                    </select>
                </div>

                {% if kieu_thong_ke == 'ngay' %}
                <div class="col-md-2">
                    <label class="form-label fw-bold">Chọn ngày</label>
                    <input type="number" name="ngay" class="form-control"
                           placeholder="Nhập từ 1 đến 31" value="{{ ngay_chon }}" min="1" max="31">
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-bold">Chọn tháng</label>
                    <select name="thang" class="form-select">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if thang_chon== m %}selected{% endif %}>Tháng {{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Chọn năm</label>
                    <input type="number" name="nam" class="form-control" value="{{ nam_chon }}" min="2000" max="3000" required>
                </div>
                {% else %}
                <div class="col-md-4">
                    <label class="form-label fw-bold">Chọn năm</label>
                    <input type="number" name="nam" class="form-control" value="{{ nam_chon }}" min="2000" max="3000" required>
                </div>
                {% endif %}

                {% else %}
                <div class="col-md-4">
                    <label class="form-label fw-bold">Chọn năm</label>
                    <input type="number" name="nam" class="form-control" value="{{ nam_chon }}" min="2000" max="3000">
                </div>
                {% endif %}

                <div class="col-md-4">
                    <button type="submit" name="action" value="view" class="btn btn-success w-100 h-100">
                        <i class="fas fa-search me-2"></i>Xem báo cáo
                    </button>
                </div>
            </form>

        </div>
    </div>


    {% if not has_submitted %}
    <div class="text-center py-5 my-5">
        <h3 class="text-muted">Chưa có thống kê nào được hiển thị</h3>
        <p class="lead text-secondary">
            Vui lòng chọn thời gian và bấm <strong>"Xem báo cáo"</strong> để xem kết quả
        </p>
    </div>
    {% endif %}

    {% if has_submitted and loai_thong_ke == 'doanh_thu' %}
    {% if doanh_thu_data %}
    <div class="card shadow">
        <div class="card-header bg-primary text-white text-center">
            <h4 class="mb-0">{{ tieu_de_thong_ke }}</h4>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="table-dark text-center">
                    <tr>
                        <th>Thời gian</th>
                        <th>Tổng doanh thu</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for row in doanh_thu_data %}
                    <tr>
                        <td class="text-center fw-bold fs-5">
                            {% if kieu_thong_ke == 'ngay' %}{{ row[0]|int }}/{{ thang_chon }}/{{ nam_chon }}
                            {% elif kieu_thong_ke == 'thang' %}Tháng {{ row[0] }}
                            {% elif kieu_thong_ke == 'quy' %}Quý {{ row[0] }}{% endif %}
                        </td>
                        <td class="text-end fw-bold fs-5">
                            {{ "{:,.0f}".format(row[1]) }} đ
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                    <tfoot class="table-success">
                    <tr>
                        <th class="text-center">TỔNG DOANH THU</th>
                        <th class="text-end fw-bold fs-4 text-dark">
                            {{ "{:,.0f}".format(tong_doanh_thu) }} đ
                        </th>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    {% if pagination and kieu_thong_ke == 'ngay' and not ngay_cu_the %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('quanly_baocao',page=pagination.prev_num,
                loai_thong_ke=loai_thong_ke,kieu_thong_ke=kieu_thong_ke,
                thang=thang_chon,nam=nam_chon,action='view') }}">Trước
                </a>
            </li>
            {% for p in pagination.iter_pages() %}
            {% if p %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link"
                   href="{{ url_for('quanly_baocao', page=p, loai_thong_ke=loai_thong_ke,
                   kieu_thong_ke=kieu_thong_ke, thang=thang_chon, nam=nam_chon, action='view')}}">{{ p }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
            {% endfor %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('quanly_baocao',page=pagination.next_num,
                loai_thong_ke=loai_thong_ke,kieu_thong_ke=kieu_thong_ke,
                thang=thang_chon,nam=nam_chon,action='view') }}">Tiếp
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="fas fa-chart-bar fa-5x mb-4 opacity-50"></i>
        <h3>Không có dữ liệu nào về doanh thu trong năm {{ nam_chon }}</h3>
    </div>
    {% endif %}
    {% endif %}

    {% if has_submitted and loai_thong_ke == 'loai_xe' %}
    {% if ty_le_xe_data %}
    <h1 class="text-center text-primary mt-2">{{ tieu_de_thong_ke }}</h1>
    <div class="row">
        <div class="col-md-5 col-6">
            <table class="table table-bordered">
                <thead class="table-dark text-center">
                <tr>
                    <th>Loại xe</th>
                    <th>Tỷ lệ</th>
                </tr>
                </thead>
                <tbody>
                {% for item in ty_le_xe_data %}
                <tr>
                    <td class="fw-bold">{{ item.ten_xe }}</td>
                    <td class="fw-bold text-end">{{ item.phan_tram }}%</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-md-7 col-6">
            <canvas id="chartLoaiXe"></canvas>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="fas fa-motorcycle fa-5x mb-4 opacity-50"></i>
        <h5>Không có dữ liệu nào về loại xe trong năm {{ nam_chon }}</h5>
    </div>
    {% endif %}
    {% endif %}

    {% if has_submitted and loai_thong_ke == 'loi_thuong_gap' %}
    {% if loi_thuong_gap_data %}
    <h1 class="text-center text-primary mt-2">{{ tieu_de_thong_ke }}</h1>
    <div class="row">
        <div class="col-md-5 col-6">
            <table class="table table-bordered">
                <thead class="table-dark text-center">
                <tr>
                    <th>STT</th>
                    <th>Tên lỗi</th>
                    <th>Số lần</th>
                </tr>
                </thead>
                <tbody>
                {% for row in loi_thuong_gap_data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ row[0] }}</td>
                    <td class="text-center">{{ row[1] }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-md-7 col-6">
            <canvas id="chartLoi"></canvas>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="fas fa-exclamation-triangle fa-5x mb-4 opacity-50"></i>
        <h5>Không có dữ liệu nào về lỗi trong năm {{ nam_chon }}</h5>
    </div>
    {% endif %}
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.chartLoaiXe instanceof Chart) window.chartLoaiXe.destroy();
            if (window.chartLoi instanceof Chart) window.chartLoi.destroy();

            {% if loai_thong_ke == 'loai_xe' and ty_le_xe_data %}
            let labelsXe = [];
            let dataXe = [];
            {% for item in ty_le_xe_data %}
            labelsXe.push('{{ item.ten_xe }}');
            dataXe.push({{ item.phan_tram }});
            {% endfor %}
            const ctxXe = document.getElementById('chartLoaiXe');
            if (ctxXe) {
                  window.chartLoaiXe = new Chart(ctxXe, {
                    type: 'bar',
                    data: { labels: labelsXe, datasets: [{ data: dataXe, backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'] }] },
                    options: { responsive: true,
                     plugins: {
                            legend: { display: false }
                        },
                     scales: { y: { beginAtZero: true } } }
                });
            }
            {% endif %}

            {% if loai_thong_ke == 'loi_thuong_gap' and loi_thuong_gap_data %}
            let labelsLoi = [];
            let dataLoi = [];
            {% for row in loi_thuong_gap_data %}
            labelsLoi.push('{{ row[0] }}');
            dataLoi.push({{ row[1] }});
            {% endfor %}
            const ctxLoi = document.getElementById('chartLoi');
            if (ctxLoi) {
                window.chartLoi = new Chart(ctxLoi, {
                    type: 'pie',
                    data: { labels: labelsLoi, datasets: [{ data: dataLoi, backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'] }] },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
            }
            {% endif %}
        });
    </script>

</section>
{% endblock %}