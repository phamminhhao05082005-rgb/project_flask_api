{% extends 'quanly/base_quanly.html' %}
<!--{% block title %}Báo cáo thống kê{% endblock %}-->

{% block quanly_content %}
<section class="container mt-4">
    <h2>Báo cáo - Thống kê</h2>
    {% include 'layout/flash_messages.html' %}

    <!-- Form chọn loại thống kê -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Chọn loại thống kê</h5>
        </div>
        <div class="card-body">
            <form method="POST" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Loại thống kê</label>
                    <select name="loai_thong_ke" class="form-select" onchange="this.form.submit()">
                        <option value="doanh_thu" {% if loai_thong_ke=='doanh_thu' %}selected{% endif %}>
                            Doanh thu
                        </option>
                        <option value="loai_xe" {% if loai_thong_ke=='loai_xe' %}selected{% endif %}>
                            Tỷ lệ loại xe
                        </option>
                        <option value="loi_thuong_gap" {% if loai_thong_ke=='loi_thuong_gap' %}selected{% endif %}>
                            Lỗi thường gặp
                        </option>
                    </select>
                </div>

                {% if loai_thong_ke in ['doanh_thu', 'loi_thuong_gap','loai_xe'] %}
                <div class="col-md-4">
                    <label class="form-label fw-bold">Chọn ngày thống kê</label>
                    <input type="date" name="ngay_thong_ke" class="form-control"
                           value="{{ ngay_chon }}" required>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">Xem báo cáo</button>
                </div>
                {% endif %}
            </form>
        </div>
    </div>


    {% if loai_thong_ke in ['doanh_thu', 'loi_thuong_gap','loai_xe'] and not ngay_chon %}
    <div class="text-center py-5 my-5">
        <i class="fas fa-calendar-alt fa-4x text-primary mb-4"></i>
        <h4 class="text-muted">
            {% if loai_thong_ke == 'doanh_thu' %}
            Hãy chọn ngày và nhấn "Xem báo cáo" để xem doanh thu
            {% elif loai_thong_ke == 'loai_xe' %}
            Hãy chọn ngày và nhấn "Xem báo cáo" để xem tỷ lệ loại xe
            {% else %}
            Hãy chọn ngày và nhấn "Xem báo cáo" để xem lỗi thường gặp
            {% endif %}
        </h4>
        <p class="text-secondary">Dữ liệu sẽ hiện ngay khi bạn chọn xong</p>
    </div>
    {% endif %}


    <!-- Nội dung theo loại -->
    {% if loai_thong_ke == 'doanh_thu' and ngay_chon %}
    <div class="card shadow">
        <div class="card-header bg-success text-white d-flex justify-content-between">
            <h4 class="mb-0">
                Doanh thu ngày <span class="text-warning fw-bold">{{ ngay_hien_thi }}</span>
            </h4>
            <h3 class="mb-0 text-warning fw-bold">
                {{ "{:,.0f}".format(doanh_thu_ngay) }} đ
            </h3>
        </div>
        <div class="card-body">
            <p class="text-muted">Tổng cộng: <strong>{{ tong_hoa_don }}</strong> hóa đơn</p>

            {% if hoa_don_trong_ngay %}
            <div class="table-responsive">
                <table class="table table-hover table-bordered">
                    <thead class="table-dark">
                    <tr>
                        <th>STT</th>
                        <th>Mã hóa đơn</th>
                        <th>Mã phiếu sửa</th>
                        <th>Tổng tiền</th>
                        <th>Ngày thanh toán</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for pt in hoa_don_trong_ngay %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td><span class="badge bg-primary">#{{ pt.id }}</span></td>
                        <td>{{ pt.phieu_sua_chua_id }}</td>
                        <td class="text-end fw-bold text-success">
                            {{ "{:,.0f}".format(pt.tong_tien) }} đ
                        </td>
                        <td>{{ pt.ngay_thanh_toan.strftime('%d/%m/%Y') }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                    <tfoot class="table-success">
                    <tr>
                        <th colspan="3" class="text-end">TỔNG DOANH THU:</th>
                        <th class="text-end fw-bold fs-5">{{ "{:,.0f}".format(doanh_thu_ngay) }} đ</th>
                        <th></th>
                    </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5 text-muted">
                <h5>Chưa có hóa đơn nào trong ngày này</h5>
            </div>
            {% endif %}
        </div>
    </div>

    {% elif loai_thong_ke == 'loai_xe' and ngay_chon %}
    <div class="card shadow-lg border-0 mb-5">
        <div class="card-header text-white text-center rounded-top"
             style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
            <h4 class="mb-0 py-3">
                <i class="fas fa-motorcycle me-2"></i>
                TỶ LỆ LOẠI XE KHÁCH MANG ĐẾN SỬA
            </h4>
        </div>
        <div class="card-body p-5 bg-light">
            {% if ty_le_xe_data %}
            <canvas id="chartTyLeXe" height="500"></canvas>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const ctx = document.getElementById('chartTyLeXe');
                const labels = {{ ty_le_xe_data|map(attribute='ten_xe')|list|tojson }};
                const phanTram = {{ ty_le_xe_data|map(attribute='phan_tram')|list|tojson }};
                const soLuong = {{ ty_le_xe_data|map(attribute='so_luong')|list|tojson }};

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tỷ lệ',
                            data: phanTram,
                            backgroundColor: ['#27ae60', '#2ecc71', '#55efc4', '#00b894', '#00cec9', '#74b9ff', '#a29bfe', '#fd79a8', '#fdcb6e', '#e17055'],
                            borderColor: '#fff',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw}% (${soLuong[context.dataIndex]} xe)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%', font: { size: 14, weight: 'bold' } }, grid: { display: false } },
                            y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 14 } } }
                        },
                        animation: {
                            onComplete: function() {
                                const ctx = this.ctx;
                                ctx.font = 'bold 16px Arial';
                                ctx.fillStyle = '#2c3e50';
                                ctx.textAlign = 'left';
                                this.data.datasets[0].data.forEach((value, i) => {
                                    const meta = this.getDatasetMeta(0);
                                    const bar = meta.data[i];
                                    ctx.fillText(value + '%', bar.x + 12, bar.y + 8);
                                });
                            }
                        }
                    }
                });
            </script>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="fas fa-motorcycle fa-5x mb-4 text-success"></i>
                <h5>Chưa có dữ liệu xe để thống kê</h5>
                <p>Hãy tiếp nhận thêm xe để xem tỷ lệ!</p>
            </div>
            {% endif %}
        </div>
    </div>

    {% elif loai_thong_ke == 'loi_thuong_gap' and ngay_chon %}
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center"
             style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
            <h4 class="mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                TOP 10 LỖI THƯỜNG GẶP
            </h4>
            <form method="POST" class="d-inline">
                <input type="hidden" name="loai_thong_ke" value="loi_thuong_gap">
                <input type="hidden" name="ngay_thong_ke" value="{{ ngay_chon or '' }}">
                <select name="loai_bieu_do" class="form-select form-select-sm bg-white text-dark fw-bold"
                        style="width: auto;" onchange="this.form.submit()">
                    <option value="cot" {% if loai_bieu_do=='cot' %}selected{% endif %}>
                        Biểu đồ cột
                    </option>
                    <option value="tron" {% if loai_bieu_do=='tron' %}selected{% endif %}>
                        Biểu đồ tròn
                    </option>
                </select>
            </form>
        </div>

        <div class="card-body p-4">
            {% if loi_thuong_gap_data %}
            <canvas id="chartLoiThuongGap" height="420"></canvas>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const ctx = document.getElementById('chartLoiThuongGap');
                const labels = {{ loi_thuong_gap_data|map(attribute='ten_loi')|list|tojson }};
                const dataValues = {{ loi_thuong_gap_data|map(attribute='so_lan')|list|tojson }};

                new Chart(ctx, {
                    type: '{{ 'bar' if loai_bieu_do == 'cot' else 'pie' }}',
                    data: {
                        labels: labels,
                        datasets: [{
                           label:'Số lượng lỗi phổ biến',
                           data: dataValues,
                           backgroundColor: '{{ loai_bieu_do }}' === 'cot' ? '#007bff' : [
                            '#D32F2F', '#5D4037', '#616161', '#0277BD',
                            '#7B1FA2', '#F57C00', '#FDD835', '#29B6F6',
                            '#C2185B', '#FF1744'
                ],
                borderColor: '#ffffff',
                borderWidth: 2,
                borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { size: 14 }, padding: 20, color: '#2d3436' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.raw + ' lần';
                                    }
                                }
                            }
                        },
                        {% if loai_bieu_do == 'cot' %}
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, color: '#2d3436' },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: { grid: { display: false } }
                        }
                        {% endif %}
                    }
                });
            </script>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-chart-pie fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">Chưa có dữ liệu lỗi</h5>
                <p class="text-muted">Hãy tiếp nhận thêm phiếu sửa chữa để xem thống kê!</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</section>
{% endblock %}